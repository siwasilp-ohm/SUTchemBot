# ============================================================================
# Apache Virtual Host Configuration for ChemInventory AI
# File Location: /etc/apache2/sites-available/ohm044.xyz.conf
# Domain: https://ohm044.xyz/v1
# ============================================================================

# ════════════════════════════════════════════════════════════
# HTTP to HTTPS Redirect
# ════════════════════════════════════════════════════════════
<VirtualHost *:80>
    ServerName ohm044.xyz
    ServerAlias www.ohm044.xyz
    ServerAdmin admin@ohm044.xyz
    
    # Redirect all HTTP traffic to HTTPS
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    </IfModule>
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/ohm044.xyz-http-error.log
    CustomLog ${APACHE_LOG_DIR}/ohm044.xyz-http-access.log combined
</VirtualHost>

# ════════════════════════════════════════════════════════════
# HTTPS Configuration (Main)
# ════════════════════════════════════════════════════════════
<VirtualHost *:443>
    ServerName ohm044.xyz
    ServerAlias www.ohm044.xyz
    ServerAdmin admin@ohm044.xyz
    
    # Document root
    DocumentRoot /var/www/html
    
    # ── SSL Configuration ──
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/ohm044.xyz/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/ohm044.xyz/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ohm044.xyz/chain.pem
    
    # ── SSL Security Configuration ──
    # Enable HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # SSL Protocols and Ciphers (Modern/Intermediate configuration)
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLPreferServerCipherSuites on
    SSLSessionCache shmcb:/var/run/apache2/ssl_scache(512000)
    SSLSessionCacheTimeout 300
    
    # ── Application Directory Configuration ──
    <Directory /var/www/html/v1>
        # Allow .htaccess overrides
        AllowOverride All
        
        # Grant access
        Require all granted
        
        # Enable rewrite engine
        <IfModule mod_rewrite.c>
            RewriteEngine On
        </IfModule>
    </Directory>
    
    # ── API Directory (Explicit configuration for API endpoints) ──
    <Directory /var/www/html/v1/api>
        AllowOverride All
        Require all granted
    </Directory>
    
    # ── Pages Directory ──
    <Directory /var/www/html/v1/pages>
        AllowOverride All
        Require all granted
    </Directory>
    
    # ── Assets Directory (Static files) ──
    <Directory /var/www/html/v1/assets>
        AllowOverride All
        Require all granted
        
        # Disable PHP execution
        <IfModule mod_php.c>
            php_flag engine off
        </IfModule>
        
        # Block PHP files from being executed
        <Files "*.php">
            Deny from all
        </Files>
    </Directory>
    
    # ── Upload Directory (Extra Protection) ──
    <Directory /var/www/html/v1/assets/uploads>
        AllowOverride All
        Require all granted
        
        # Prevent script execution
        <IfModule mod_php.c>
            php_flag engine off
        </IfModule>
        
        # Block executable files
        <FilesMatch "\.(php|php3|php4|php5|php6|php7|php8|phtml|pht|phps|shtml|exe|sh|bat|cmd)$">
            Deny from all
        </FilesMatch>
        
        # Add UTF-8 charset
        AddType text/plain .php
    </Directory>
    
    # ── Includes Directory (Deny direct access) ──
    <Directory /var/www/html/v1/includes>
        AllowOverride All
        Require all denied
    </Directory>
    
    # ── SQL Directory (Deny direct access) ──
    <Directory /var/www/html/v1/sql>
        AllowOverride All
        Require all denied
    </Directory>
    
    # ── Log Directory (Deny direct access) ──
    <Directory /var/www/html/v1/logs>
        AllowOverride All
        Require all denied
    </Directory>
    
    # ── Module3D Directory ──
    <Directory /var/www/html/v1/module3d>
        AllowOverride All
        Require all granted
    </Directory>
    
    # ── AR Module Directory ──
    <Directory /var/www/html/v1/ar>
        AllowOverride All
        Require all granted
    </Directory>
    
    # ── Logging ──
    ErrorLog ${APACHE_LOG_DIR}/ohm044.xyz-error.log
    CustomLog ${APACHE_LOG_DIR}/ohm044.xyz-access.log combined
    
    # ── Compression ──
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css text/javascript application/javascript application/x-javascript application/xml
    </IfModule>
    
    # ── Browser Caching ──
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 2 days"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType text/html "access plus 2 hours"
        ExpiresByType application/json "access plus 0 seconds"
    </IfModule>
    
    # ── Security Headers ──
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
        Header unset X-Powered-By
    </IfModule>
    
    # ── Character Encoding ──
    AddDefaultCharset utf-8
</VirtualHost>

# ════════════════════════════════════════════════════════════
# SSL Configuration (Let's Encrypt Auto-renewal)
# ════════════════════════════════════════════════════════════
# Note: Certbot will automatically update this file
# No manual editing needed for SSL auto-renewal
